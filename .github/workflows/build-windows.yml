name: Build Windows

on:
  workflow_call:
    inputs:
      firefox_version:
        required: true
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 420
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MozillaBuild
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe" -OutFile "MozillaBuildSetup.exe"
          Start-Process -FilePath ".\MozillaBuildSetup.exe" -ArgumentList "/S" -Wait -NoNewWindow

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Fetch Firefox source
        shell: bash
        run: |
          chmod +x build-scripts/*.sh
          ./build-scripts/fetch-firefox-source.sh "${{ inputs.firefox_version }}"

      - name: Apply FoxOne branding
        shell: bash
        run: ./build-scripts/apply-branding.sh

      - name: Apply Firefox One theme
        shell: bash
        run: ./build-scripts/apply-theme.sh

      - name: Download extensions
        shell: bash
        run: ./build-scripts/download-extensions.sh

      - name: Setup distribution
        shell: bash
        run: ./build-scripts/setup-distribution.sh

      - name: Configure build
        shell: bash
        run: |
          cp config/mozconfig.windows build/firefox-source/mozconfig
          touch build/firefox-source/mozilla-api-key

      - name: Build Firefox
        shell: cmd
        run: |
          call "C:\mozilla-build\start-shell.bat" -here -c "cd build/firefox-source && ./mach bootstrap --application-choice=browser --no-interactive || true && ./mach build && ./mach package"
        timeout-minutes: 360

      - name: Prepare output
        shell: bash
        run: |
          mkdir -p build/output/windows
          find build/firefox-source/obj-foxone -name "*.zip" -exec cp {} build/output/windows/ \; || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: foxone-windows
          path: build/output/windows/*.zip
          if-no-files-found: warn
          retention-days: 7
