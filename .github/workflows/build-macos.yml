name: Build macOS

on:
  workflow_call:
    inputs:
      firefox_version:
        required: true
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install python@3.11 node nasm yasm mercurial || true

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Install cbindgen
        run: cargo install cbindgen

      - name: Fetch Firefox source
        run: |
          chmod +x build-scripts/*.sh
          ./build-scripts/fetch-firefox-source.sh "${{ inputs.firefox_version }}"

      - name: Apply FoxOne branding
        run: ./build-scripts/apply-branding.sh

      - name: Apply Firefox One theme
        run: ./build-scripts/apply-theme.sh

      - name: Download extensions
        run: ./build-scripts/download-extensions.sh

      - name: Setup distribution
        run: ./build-scripts/setup-distribution.sh

      - name: Configure build
        run: |
          cp config/mozconfig.macos build/firefox-source/mozconfig
          touch build/firefox-source/mozilla-api-key

      - name: Bootstrap
        working-directory: build/firefox-source
        run: |
          ./mach bootstrap --application-choice=browser --no-interactive || true

      - name: Build FoxOne
        working-directory: build/firefox-source
        run: ./mach build
        timeout-minutes: 240

      - name: Package FoxOne
        working-directory: build/firefox-source
        run: ./mach package

      - name: Prepare output
        run: |
          mkdir -p build/output/macos
          find build/firefox-source/obj-foxone -name "*.dmg" -exec cp {} build/output/macos/FoxOne-${{ inputs.firefox_version }}.dmg \; || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: foxone-macos
          path: build/output/macos/*.dmg
          if-no-files-found: warn
          retention-days: 7
